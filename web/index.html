<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>ROS Web Control â€” TurtleBot3 Waffle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- roslibjs -->
  <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  <!-- nipplejs (joystick) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --txt: #e5e7eb;
      --accent: #22d3ee;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--txt);
    }

    header {
      padding: 18px 22px;
      font-weight: 700;
      letter-spacing: .3px;
      border-bottom: 1px solid #1f2937;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px;
      display: grid;
      gap: 22px;
      grid-template-columns: 1fr 420px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
    }

    .row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: #0b1220;
      color: var(--txt);
      cursor: pointer;
      font-weight: 600;
      transition: 0.1s;
    }

    button:hover {
      border-color: #4b5563;
      transform: translateY(-1px);
    }

    button.active {
      background: var(--accent);
      color: #000;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .big {
      font-size: 18px;
      padding: 14px 0;
    }

    img.stream {
      width: 100%;
      max-height: 520px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #374151;
      background: #000;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #1f2937;
      font-size: 14px;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #0b1220;
    }

    .muted {
      color: #9ca3af;
    }

    .ok {
      color: #34d399;
    }

    .warn {
      color: #f59e0b;
    }

    .err {
      color: #f43f5e;
    }

    #joystick {
      width: 200px;
      height: 200px;
      margin: 20px auto;
    }
  </style>
</head>

<body>
  <header>ROS Web Control â€” TurtleBot3 Waffle</header>

  <div class="wrap">
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span>Status:</span>
          <span id="sim-status" class="badge muted">checkingâ€¦</span>
        </div>
        <div class="row">
          <button id="startBtn">Start Robot</button>
          <button id="stopBtn">Stop Robot</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <img id="cam" class="stream" alt="Camera stream" />
        <div class="row" style="margin-top:6px; justify-content:space-between">
          <div class="muted">Topic: /camera/rgb/image_raw</div>
          <button id="snapshotBtn">ðŸ“¸ Snapshot</button>
        </div>
      </div>

      <div style="margin-top:18px">
        <div class="row" style="justify-content:center; margin-bottom:8px">
          <span class="muted">Teleop (WASD/Arrows or joystick)</span>
        </div>
        <div class="grid">
          <div></div> <button class="big" data-cmd="FWD">â–²</button>
          <div></div>
          <button class="big" data-cmd="LEFT">â—€</button>
          <button class="big" data-cmd="STOP">â– </button>
          <button class="big" data-cmd="RIGHT">â–¶</button>
          <div></div> <button class="big" data-cmd="BACK">â–¼</button>
          <div></div>
        </div>
        <div id="joystick"></div>
      </div>

      <div style="margin-top:18px" class="row" id="telemetry">
        <span>Battery: <span id="battery">--%</span></span>
        <span>Odom: <span id="odom">(0,0)</span></span>
      </div>
    </section>

    <aside class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Logs (last 60 min)</h3>
        <button id="refreshLogs">Refresh</button>
      </div>
      <table id="logs" style="margin-top:10px">
        <thead>
          <tr>
            <th>Time</th>
            <th>Level</th>
            <th>Event</th>
            <th>Detail</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </aside>
  </div>

  <script>
    // --- Config ---
    const HOST = location.hostname;
    const ROSBRIDGE_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + HOST + ':9090';
    const MJPEG_URL = location.protocol + '//' + HOST + ':8080/stream?topic=/camera/image_raw';
    const API = location.origin + '/api'; // pastikan ini! (bukan :8000)

    document.getElementById('cam').src = MJPEG_URL;

    let ros, cmdVel;

    async function log(event, detail = '', level = 'INFO') {
      try {
        await fetch(`${API}/log`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ event, detail, level })
        });
      } catch (e) { /* silent */ }
    }

    function connectROS() {
      if (typeof ROSLIB === 'undefined') {
        console.error('ROSLIB not loaded! Retrying in 2 seconds...');
        setTimeout(connectROS, 2000);
        return;
      }
      
      ros = new ROSLIB.Ros({ url: ROSBRIDGE_URL });

      ros.on('connection', () => {
        setStatus('running');
        cmdVel = new ROSLIB.Topic({
          ros, name: '/cmd_vel', messageType: 'geometry_msgs/Twist'
        });
        
        console.log('ROS connected, cmdVel topic initialized');

        // === Subscribe /cmd_vel untuk nge-log setiap ada perintah
        const cmdVelEcho = new ROSLIB.Topic({
          ros, name: '/cmd_vel', messageType: 'geometry_msgs/Twist'
        });
        cmdVelEcho.subscribe(msg => {
          const d = `lx=${msg.linear.x.toFixed(3)}, az=${msg.angular.z.toFixed(3)}`;
          log('cmd_vel', d);
        });

        // Subscribe telemetry - hanya odom yang tersedia
        const odom = new ROSLIB.Topic({
          ros, name: '/odom', messageType: 'nav_msgs/Odometry'
        });
        odom.subscribe(msg => {
          const { x, y } = msg.pose.pose.position;
          document.getElementById('odom').textContent = `(${x.toFixed(2)}, ${y.toFixed(2)})`;
          console.log(`Odom updated: x=${x.toFixed(2)}, y=${y.toFixed(2)}`);
        });
        
        // Set battery static karena tidak ada publisher
        document.getElementById('battery').textContent = '100%';

        log('websocket', 'connected to rosbridge');
      });

      ros.on('error', () => {
        setStatus('error');
        log('websocket', 'connection error', 'ERROR');
      });
      ros.on('close', () => {
        setStatus('disconnected');
        log('websocket', 'connection closed', 'WARN');
        setTimeout(connectROS, 2000);
      });
    }

    function setStatus(s) {
      const el = document.getElementById('sim-status');
      const cls = { connected:'ok', running:'ok', disconnected:'warn', error:'err', checking:'muted', stopped:'warn' };
      el.className = 'badge ' + (cls[s] || 'muted');
      el.textContent = s;
    }

    function sendTwist(lx = 0, az = 0) {
      if (!ros || !cmdVel) {
        console.error('ROS or cmdVel not initialized! Reconnecting...');
        connectROS();
        return;
      }
      
      // Log bahwa function dipanggil
      console.log(`sendTwist called: lx=${lx}, az=${az}`);
      
      try {
        const msg = new ROSLIB.Message({
          linear: { x: lx, y: 0, z: 0 },
          angular: { x: 0, y: 0, z: az }
        });
        cmdVel.publish(msg);
        console.log('Message published successfully');
      } catch (e) {
        console.error('Error publishing message:', e);
        // Reconnect jika ada error
        connectROS();
      }
    }

    const SPEED = 0.3, TURN = 0.9, FAST = 2.0;

    function bindTeleop() {
      const map = {
        FWD: () => sendTwist(SPEED, 0),
        BACK: () => sendTwist(-SPEED, 0),
        LEFT: () => sendTwist(0, TURN),
        RIGHT: () => sendTwist(0, -TURN),
        STOP: () => sendTwist(0, 0),
      };
      document.querySelectorAll('button[data-cmd]').forEach(btn => {
        btn.addEventListener('mousedown', () => { 
          console.log('Button pressed:', btn.dataset.cmd);
          map[btn.dataset.cmd](); 
          log('teleop', btn.dataset.cmd.toLowerCase()); 
        });
        btn.addEventListener('mouseup', () => {
          console.log('Button released, stopping robot');
          sendTwist(0, 0);
        });
        btn.addEventListener('mouseleave', () => {
          console.log('Mouse left button, stopping robot');
          sendTwist(0, 0);
        });
        btn.addEventListener('touchstart', (e) => { 
          e.preventDefault(); 
          console.log('Touch started:', btn.dataset.cmd);
          map[btn.dataset.cmd](); 
          log('teleop', btn.dataset.cmd.toLowerCase()); 
        });
        btn.addEventListener('touchend', (e) => {
          e.preventDefault();
          console.log('Touch ended, stopping robot');
          sendTwist(0, 0);
        });
      });

      window.addEventListener('keydown', e => {
        const fast = e.shiftKey ? FAST : 1.0;
        if (['ArrowUp','w','W'].includes(e.key)) { 
          sendTwist(SPEED*fast,0); 
          log('teleop','key:FWD' + (fast > 1 ? ' (fast)' : '')); 
        }
        else if (['ArrowDown','s','S'].includes(e.key)) { 
          sendTwist(-SPEED*fast,0); 
          log('teleop','key:BACK' + (fast > 1 ? ' (fast)' : '')); 
        }
        else if (['ArrowLeft','a','A'].includes(e.key)) { 
          sendTwist(0,TURN*fast); 
          log('teleop','key:LEFT' + (fast > 1 ? ' (fast)' : '')); 
        }
        else if (['ArrowRight','d','D'].includes(e.key)) { 
          sendTwist(0,-TURN*fast); 
          log('teleop','key:RIGHT' + (fast > 1 ? ' (fast)' : '')); 
        }
      });
      window.addEventListener('keyup', e => {
        // Hanya stop jika key yang di-release adalah key navigasi
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 
             'w', 'W', 'a', 'A', 's', 'S', 'd', 'D'].includes(e.key)) {
          sendTwist(0, 0);
          console.log('Key released, stopping robot');
        }
      });
    }

    // === Snapshot tombol ===
    document.getElementById('snapshotBtn')?.addEventListener('click', async () => {
      try {
        // ambil frame dari <img id="cam">
        const img = document.getElementById('cam');
        const c = document.createElement('canvas');
        c.width = img.naturalWidth || img.width; 
        c.height = img.naturalHeight || img.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, c.width, c.height);
        const dataURL = c.toDataURL('image/jpeg', 0.9);
        await fetch(`${API}/snapshot`, {
          method: 'POST', 
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ dataURL, topic: '/camera/image_raw' })
        });
        await log('snapshot', 'image saved to server');
        alert('Snapshot saved');
      } catch (e) {
        console.error('Snapshot failed:', e);
        log('snapshot', 'failed: ' + e.message, 'ERROR');
      }
    });

    function initJoystick() {
      const manager = nipplejs.create({
        zone: document.getElementById('joystick'),
        mode: 'dynamic',
        color: 'cyan'
      });
      manager.on('move', (evt, data) => {
        const lx = SPEED * (data.vector.y * -1);
        const az = TURN * data.vector.x;
        sendTwist(lx, az);
      });
      manager.on('end', () => {
        sendTwist(0, 0);
        log('teleop', 'joystick_end');
      });
      manager.on('start', () => {
        log('teleop', 'joystick_start');
      });
    }

    async function toggle(action) {
      try {
        const r = await fetch(`${API}/toggle?action=${action}`, { method: 'POST' });
        const data = await r.json();
        await log('robot_control', action + ' requested');
        checkHealth();
        return data;
      } catch (e) {
        await log('robot_control', action + ' failed: ' + e.message, 'ERROR');
        return {};
      }
    }
    document.getElementById('startBtn').onclick = () => toggle('start');
    document.getElementById('stopBtn').onclick = () => toggle('stop');

    async function checkHealth() {
      try {
        const r = await fetch(`${API}/robot/health`);
        const { running } = await r.json();
        const oldStatus = document.getElementById('sim-status').textContent;
        const newStatus = running ? 'running' : 'stopped';
        
        // Jika status robot berubah dari stopped ke running, reinitialize ROS connection
        if (oldStatus === 'stopped' && newStatus === 'running') {
          console.log('Robot restarted, reinitializing ROS connection');
          if (ros) {
            ros.close();
          }
          setTimeout(connectROS, 1000);
        }
        
        setStatus(newStatus);
      } catch { 
        setStatus('disconnected'); 
      }
    }

    async function loadLogs() {
      const tbody = document.querySelector('#logs tbody'); 
      tbody.innerHTML = '';
      try {
        const r = await fetch(`${API}/logs?minutes=60`);
        const rows = await r.json();
        rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${new Date(row.ts).toLocaleTimeString()}</td>
                          <td>${row.level}</td>
                          <td>${row.event}</td>
                          <td class="muted">${row.detail||''}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.warn('Failed to load logs:', e);
      }
    }
    document.getElementById('refreshLogs').onclick = loadLogs;

    (function init(){
      setStatus('checking');
      connectROS();
      bindTeleop();
      initJoystick();
      checkHealth();
      loadLogs();
      setInterval(loadLogs, 15000);
      setInterval(checkHealth, 5000);
      log('app', 'web interface started');
    })();
  </script>
</body>
</html>
